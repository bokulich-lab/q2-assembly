{% extends 'tabbed.html' %}

{% block head %}
<title>Contig QC Dashboard (Vega-Lite)</title>
<script src="js/bootstrapMagic.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/vega@6"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@6"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="css/styles.css" rel="stylesheet"/>

{% endblock %}

{% block tabcontent %}
<div class="container-fluid">
  <div class="row justify-content-center" style="margin-top: 20px;">
    <div class="col-lg-10 col-xl-8">
      <div class="card mb-4 border-muted">
        <div class="card-body p-3">
          <div class="card-text text-muted">
            This visualization shows contig quality metrics (length distribution, Nx curve, GC content, cumulative length) for all samples, grouped by metadata categories. Loading may take a while for large datasets. Changing categories in the dropdown may take a few seconds for the charts to update.
          </div>
          <div class="card-text text-muted" style="margin-top: 10px;">
            Pick a metadata category and value to filter the plots below.
          </div>
          <div class="row selector-row justify-content-left mb-10"  style="margin-top: 10px; margin-bottom: 10px;">
            <div class="col-auto">
              <label for="categoryDropdown" class="form-label fw-bold">Metadata category:</label>
              <select id="categoryDropdown" class="form-select custom-dropdown">
                <!-- Options will be populated by JS -->
              </select>
            </div>
            <div class="col-auto">
              <label for="valueDropdown" class="form-label fw-bold">Value:</label>
              <select id="valueDropdown" class="form-select custom-dropdown">
                <!-- Options will be populated by JS -->
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="mx-10">
        <div class="row dashboard-row justify-content-center">
          <div class="col-md-6 mb-4"><div id="vega-contig-length"></div></div>
          <div class="col-md-6 mb-4"><div id="vega-nx-curve"></div></div>
        </div>
        <div class="row dashboard-row justify-content-center">
          <div class="col-md-6 mb-4"><div id="vega-gc-content"></div></div>
          <div class="col-md-6 mb-4"><div id="vega-cumulative-length"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Data injected from Python ---
  const categories = {{ categories | safe }};
  const values = {{ values | safe }};
  const vegaContigLengthSpec = {{ vega_contig_length_spec | safe }};
  const vegaNxCurveSpec = {{ vega_nx_curve_spec | safe }};
  const vegaGcContentSpec = {{ vega_gc_content_spec | safe }};
  const vegaCumulativeLengthSpec = {{ vega_cumulative_length_spec | safe }};
</script>
<script type="text/javascript">
  $(document).ready(function () {
    removeBS3refs();
    adjustTagsToBS3();

    // Populate category dropdown
    const categoryDropdown = document.getElementById('categoryDropdown');
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      categoryDropdown.appendChild(opt);
    });

    // Helper to update value dropdown
    function updateValueDropdown(category, selectedValue) {
      const valueDropdown = document.getElementById('valueDropdown');
      valueDropdown.innerHTML = '';
      // Add 'All' option
      const allOpt = document.createElement('option');
      allOpt.value = 'All';
      allOpt.textContent = 'All';
      if (selectedValue === 'All') allOpt.selected = true;
      valueDropdown.appendChild(allOpt);
      if (values[category]) {
        values[category].forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          if (v === selectedValue) opt.selected = true;
          valueDropdown.appendChild(opt);
        });
      }
    }

    // Initial dropdown population
    const initialCategory = categories[0];
    updateValueDropdown(initialCategory, 'All');
    document.getElementById('categoryDropdown').value = initialCategory;

    // Render each plot in its own container
    let vegaViews = {};
    vegaEmbed('#vega-contig-length', vegaContigLengthSpec, {actions: true}).then(res => { 
      vegaViews.contigLength = res.view;
      vegaViews.contigLength.signal('category_param', initialCategory)
              .signal('value_param', 'All')
              .runAsync(); 
      });
    vegaEmbed('#vega-nx-curve', vegaNxCurveSpec, {actions: true}).then(res => {
      vegaViews.nxCurve = res.view;
      vegaViews.nxCurve.signal('category_param', initialCategory)
              .signal('value_param', 'All')
              .runAsync();
      });
    vegaEmbed('#vega-gc-content', vegaGcContentSpec, {actions: true}).then(res => {
      vegaViews.gcContent = res.view;
      vegaViews.gcContent.signal('category_param', initialCategory)
              .signal('value_param', 'All')
              .runAsync();
      });
    vegaEmbed('#vega-cumulative-length', vegaCumulativeLengthSpec, {actions: true}).then(res => {
      vegaViews.cumulativeLength = res.view;
      vegaViews.cumulativeLength.signal('category_param', initialCategory)
              .signal('value_param', 'All')
              .runAsync();
      });

    // Dropdown event listeners
    document.getElementById('categoryDropdown').addEventListener('change', function () {
      const category = this.value;
      updateValueDropdown(category, 'All');
      // Update Vega params for all plots
      Object.values(vegaViews).forEach(view => {
        if (view) {
          view.signal('category_param', category).signal('value_param', 'All').runAsync();
        }
      });
    });
    document.getElementById('valueDropdown').addEventListener('change', function () {
      const value = this.value;
      Object.values(vegaViews).forEach(view => {
        if (view) {
          view.signal('value_param', value).runAsync();
        }
      });
    });
  });
</script>
{% endblock %}

{% block footer %}
{% set loading_selector = '#loading' %}
{% include 'js-error-handler.html' %}
{% endblock %}
