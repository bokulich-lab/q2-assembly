{
  "$schema": "https://vega.github.io/schema/vega-lite/v6.json",
  "params": [
    {"name": "category_param", "value": "group"},
    {"name": "value_param", "value": "All"}
  ],
  "vconcat": [
    {
      "hconcat": [
        {
          "title": "Contig length distribution",
          "data": {"values": {{ seq_df | safe }}},
          "transform": [
            {"filter": "value_param == 'All' || datum[category_param] == value_param"},
            {"calculate": "log(datum.contig_length)/log(10)", "as": "log_x"},
            {"bin": {"binned":  true, "maxbin":  10, "nice":  true}, "field": "log_x", "as": "bin_log_x"},
            {"calculate": "pow(10, datum.bin_log_x)", "as": "x1"},
            {"calculate": "pow(10, datum.bin_log_x_end)", "as": "x2"}
          ],
          "mark": "bar",
          "width": 400, "height": 350,
          "selection": {
            "sample_select": {
              "type": "multi",
              "fields": ["sample"],
              "bind": "legend"
            },
            "grid": {"type": "interval", "bind": "scales", "encodings": ["x"]}
          },
          "encoding": {
            "x": {"field": "x1", "title": "Contig length", "axis": {"format": ".1s", "labelAngle": 0}},
            "x2": {"field": "x2"},
            "y": {"aggregate": "count", "title": "Count", "axis": {"format": "~s"}},
            "color": {
              "field": "sample",
              "type": "nominal",
              "scale": {"scheme": "viridis"}, "legend":  {"title":  "Sample"}},
            "opacity": {
              "condition": {"param": "sample_select", "value": 1},
              "value": 0.2
            }
          }
        },
        {
          "title": "Nx curve",
          "data": {"values": {{ nx_df | safe }}},
          "transform": [{"filter": "value_param == 'All' || datum[category_param] == value_param"}],
          "mark": {"type": "line", "point": true},
          "width": 400, "height": 350,
          "selection": {
            "sample_select": {
              "type": "multi",
              "fields": ["sample"],
              "bind": "legend"
            },
            "grid": {"type": "interval", "bind": "scales"}
          },
          "encoding": {
            "x": {"field": "percent", "type": "quantitative", "title": "Percent of assembly (Nx)"},
            "y": {"field": "nx", "type": "quantitative", "title": "Contig size (bp)", "axis": {"format": "~s"}},
            "color": {"field": "sample", "type": "nominal", "scale": {"scheme": "viridis"}, "legend":  {"title":  "Sample"}},
            "opacity": {
              "condition": {"param": "sample_select", "value": 1},
              "value": 0.2
            }
          }
        }
      ],
      "spacing": 30
    },
    {
      "hconcat": [
        {
          "title": "GC content distribution",
          "data": {"values": {{ seq_df | safe }}},
          "transform": [
            {"filter": "value_param == 'All' || datum[category_param] == value_param"},
            {"density": "gc", "groupby": ["sample"], "as": ["gc", "density"]}
          ],
          "mark": {"type": "line", "interpolate": "monotone"},
          "width": 400, "height": 350,
          "selection": {
            "sample_select": {
              "type": "multi",
              "fields": ["sample"],
              "bind": "legend"
            },
            "grid": {"type": "interval", "bind": "scales"}
          },
          "encoding": {
            "x": {"field": "gc", "type": "quantitative", "title": "GC content (%)", "bin": false},
            "y": {"field": "density", "type": "quantitative", "title": "Fraction of contigs"},
            "color": {"field": "sample", "type": "nominal", "scale": {"scheme": "viridis"}, "legend":  {"title":  "Sample"}},
            "opacity": {
              "condition": {"param": "sample_select", "value": 1},
              "value": 0.2
            }
          }
        },
        {
          "title": "Cumulative contig length",
          "data": {"values": {{ cumulative_df | safe }}},
          "transform": [{"filter": "value_param == 'All' || datum[category_param] == value_param"}],
          "mark": {"type": "line", "point": true},
          "width": 400, "height": 350,
          "selection": {
            "sample_select": {
              "type": "multi",
              "fields": ["sample"],
              "bind": "legend"
            },
            "grid": {"type": "interval", "bind": "scales"}
          },
          "encoding": {
            "x": {"field": "rank", "type": "quantitative", "title": "No. of contigs"},
            "y": {"field": "cumulative_length", "type": "quantitative", "title": "Cumulative length (bp)", "axis":  {"format": "~s"}},
            "color": {"field": "sample", "type": "nominal", "scale": {"scheme": "viridis"}, "legend":  {"title":  "Sample"}},
            "opacity": {
              "condition": {"param": "sample_select", "value": 1},
              "value": 0.2
            }
          }
        }
      ],
      "spacing": 30
    }
  ],
  "spacing": 30,
  "config": {
    "background": "#fff",
    "font": "Open Sans, Arial, sans-serif",
    "axis": {
      "grid": true,
      "gridColor": "#eaeaea",
      "gridWidth": 1,
      "tickColor": "#888",
      "labelFont": "Open Sans, Arial, sans-serif",
      "labelFontSize": 14,
      "titleFont": "Open Sans, Arial, sans-serif",
      "titleFontSize": 16,
      "titleFontWeight": "bold",
      "domain": false
    },
    "legend": {
      "orient": "top",
      "columns":5,
      "title": "Sample",
      "offset": 50,
      "labelFont": "Open Sans, Arial, sans-serif",
      "labelFontSize": 14,
      "titleFont": "Open Sans, Arial, sans-serif",
      "titleFontSize": 15,
      "symbolType": "circle",
      "symbolSize": 120,
      "symbolLimit": 100
    },
    "view": {
      "stroke": "#eaeaea",
      "strokeWidth": 1
    },
    "header": {
      "labelFont": "Open Sans, Arial, sans-serif",
      "labelFontSize": 15,
      "titleFont": "Open Sans, Arial, sans-serif",
      "titleFontSize": 17
    },
    "title": {
      "font": "Open Sans, Arial, sans-serif",
      "fontSize": 18,
      "fontWeight": "bold",
      "anchor": "middle",
      "color": "#222"
    }
  }
} 